# 更新现有交易的还款日期

## 问题说明

在添加 `payment_same_month` 字段之前，所有交易的 `expected_payment_date` 都是按照"次月还款"逻辑计算的。现在需要根据最新的 `payment_same_month` 配置重新计算。

## 解决方案

有两种方式更新现有交易的还款日期：

### 方式 1: 数据库批量更新（推荐）

执行 `update_payment_dates.sql` 脚本，一次性更新所有交易记录。

**步骤**:
1. 登录 Supabase Dashboard
2. 进入 SQL Editor
3. 复制并执行 `supabase/migrations/update_payment_dates.sql`
4. 查看执行结果，确认还款日期已正确更新

**优点**:
- 一次性更新所有历史数据
- 数据库中的日期与显示一致
- 性能更好

### 方式 2: 前端动态计算（已实现）

交易详情页面现在会动态重新计算还款日期，不再依赖数据库中存储的 `expected_payment_date`。

**特点**:
- 无需修改数据库
- 始终使用最新的 `payment_same_month` 配置
- 适合配置经常变化的场景

## 验证步骤

### 1. 检查你的示例数据

根据你提供的数据：
- **交易日期**: 2026-01-24
- **信用卡**: AMEX万豪
- **账单日**: 7日
- **还款日**: 26日
- **还款周期**: 当月还款 (payment_same_month = true)

**计算逻辑**:
1. 交易日期 2026-01-24 > 账单日 7日
2. 所以使用下个月的账单日：2026-02-07
3. 因为是当月还款，还款日在 2026-02 月
4. **正确的还款日期**: 2026-02-26 ✅

### 2. 在前端验证

1. 访问交易详情页面：http://localhost:3001/transactions/b5f7f64d-5a09-4f35-be23-a12f54004d39
2. 查看"支付信息"卡片中的"预计还款日"
3. 应该显示：**2026年2月26日** ✅

### 3. 更新数据库（可选）

如果你想让数据库中的日期也更新，执行以下 SQL：

```sql
UPDATE transactions
SET expected_payment_date = '2026-02-26'
WHERE id = 'b5f7f64d-5a09-4f35-be23-a12f54004d39';
```

或者使用批量更新脚本更新所有交易。

## 未来新增交易

所有新增的交易都会自动使用正确的还款日期计算逻辑，无需手动调整。

## 常见问题

**Q: 为什么不直接修改数据库中的日期？**
A: 前端动态计算的优点是：
   - 当你调整信用卡的 payment_same_month 配置时，所有交易的还款日期会自动更新
   - 无需每次修改配置后都重新运行迁移脚本

**Q: 数据库中的 expected_payment_date 还有用吗？**
A: 目前主要用于向后兼容。你可以选择：
   - 保留它作为备份/参考
   - 运行批量更新脚本同步最新数据
   - 在未来版本中废弃这个字段

**Q: 交易列表页面会显示正确的还款日期吗？**
A: 交易列表页面目前不显示还款日期。如果需要，我们可以添加这个功能。
